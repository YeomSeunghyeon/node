//201935292 염승현


const db=require('./db');
var qs=require('querystring');
module.exports={
  home:(req,res)=>{
    db.query('SELECT * FROM customer',(error,customers)=>{
    
       var context={list:null,control:null,body:null    };
         res.app.render('home3',context,(err,html)=>{
          res.end(html) })
      });
  },
  list:(req,res)=>{
    db.query('SELECT * FROM customer',(error,customers)=>{

      var lists='<ol type="1">' ;
      var i=0;
      while(i<customers.length){
        lists=lists+`<li><a href=/page/${customers[i].id}>${customers[i].name}</a></li>`;
        i=i+1;
      }
      var c='<a href="/create">create</a>'
      var b='<h2>Welcome</h2>'

       var context={list:lists,
        control:c,
        body:b};
         res.app.render('home3',context,(err,html)=>{
          res.end(html) })
      });
  
  },
  page:(req,res)=>{
    var id=req.params.pageId;
    db.query('SELECT*FROM customer',(error,customers)=>{
        if(error){
          throw error;
        }
        var lists='<ol type="1">' ;
        var i=0;
        while(i<customers.length){
          lists=lists+`<li><a href=/page/${customers[i].id}>${customers[i].name}</a></li>`;
          i=i+1;
        }
        db.query(`SELECT*FROM customer WHERE id=${id}`,(error2,customer)=>{
          if(error2){
            throw error2;
          }
  
          var c=`<a href="/create">create</a>&nbsp;&nbsp;
          <a href="/update/${customer[0].id}">update</a>&nbsp;&nbsp;
          <a href="/delete/${customer[0].id}"onclick='if(confirm("정말로 삭제하시겠습니까?")==false){return false}'>delete</a>`
          var b=`<p>이름:${customer[0].name}</p><p>주소:${customer[0].address}</p>
          <p>생년원일:${customer[0].birth}</p><p>전화번호:${customer[0].tel}</p>`
          var context={list:lists,
                        control:c,
                        body:b};
          req.app.render('home3',context,(err,html)=>{
            res.end(html) })
        })
    })
  },
  create:(req,res)=>{
    db.query('SELECT*FROM customer',(error,customers)=>{
      if(error){
        throw error;
      }
      var lists='<ol type="1">' ;
      var i=0;
      while(i<customers.length){
        lists=lists+`<li><a href=/page/${customers[i].id}>${customers[i].name}</a></li>`;
        i=i+1;
      }
      var context={list:lists,
                    control:`<a href="/create">create</a>`,
                    body:`<form action="/create_process" method="post">
                          <p><input type="text" name="name" placeholder="name"></P>
                          <p><input type="text" name="address" placeholder="address"></p>
                          <p><input type="text" name="birth" placeholder="birth"></p>
                          <p><input type="text" name="tel" placeholder="tel"></p>
                          <p><input type="submit"></p></form>`
      };
      req.app.render('home3',context,(err,html)=>{
        res.end(html);
      });
                
  })
},
create_process:(req,res)=>{
  var body='';
  req.on('data',(data)=>{
    body=body+data;
  });
  req.on('end',()=>{
    var post=qs.parse(body);
    db.query(`
    INSERT INTO customer (name,address,birth,tel)   
     VALUES(?,?,?,?)`,
    [post.name,post.address,post.birth,post.tel],(error,result)=>{
      if(error){
        throw error;
      }
      res.writeHead(302,{Location:`/page/${result.insertId}`});  //insertID는 내가 방금 입력한 것의 ID가 알아서 들어감
      res.end();
    });
  });
},
update:function(request,response){
  var _url=request.url;
  id=request.params.pageId;
              db.query('SELECT*FROM customer',function(error,customers){
                  if(error){
                    throw error;
                  }
                  var lists='<ol type="1">' ;
                  var i=0;
                  while(i<customers.length){
                    lists=lists+`<li><a href=/page/${customers[i].id}>${customers[i].name}</a></li>`;
                    i=i+1;
                  }
                  db.query(`SELECT*FROM customer WHERE id=?`,[id],function(error2,customer){
                    if(error2){
                      throw error2;
                    }
                    var context={list:lists,
                      control:`<a href="/create">create</a>&nbsp;&nbsp;<a href="/update/${customer[0].id}">update</a>`,
                      body:`<form action="/update_process" method="post">
                      <input type="hidden" name="id" value="${customer[0].id}" >
                      <p><input type="text" name="name" placeholder="name" value="${customer[0].name}"></p>
                      <p><input type="text" name="address" placeholder="address" value="${customer[0].address}"></p>
                          <p><input type="text" name="birth" placeholder="birth"  value="${customer[0].birth}"></p>
                          <p><input type="text" name="tel" placeholder="tel"  value="${customer[0].tel}"></p>
                      <p><input type="submit"></p></form>`
                    };
                    request.app.render('home3',context,function(err,html){
                      response.end(html);
                    });
});
});
},
update_process:(req,res)=>{
  var body='';
  req.on('data',(data)=>{
    body=body+data;
  });
  req.on('end',()=>{
    var post=qs.parse(body);
    db.query('UPDATE customer SET name=?,address=?,birth=?,tel=? WHERE id=?',
    [post.name,post.address,post.birth,post.tel,post.id],(error,result)=>{
      res.writeHead(302,{Location:`/page/${post.id}`});
      res.end();
    });
  });
},
delete_process:(req,res)=>{
  id=req.params.pageId;
  db.query('DELETE FROM customer WHERE id=?',[id],(error,result)=>{
    if(error){
      throw error;
    }
    res.writeHead(302,{Location:`/`});
    res.end();
  });
}
}